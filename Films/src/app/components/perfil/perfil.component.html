<section class="profile">
  <section class="box-mi-perfil">
    <img class="account" src="/assets/account.png" alt="">
    <h2 class="sub-title">Mi perfil</h2>
  </section>

  <section class="box-datos-personales">
    <h3 class="sub-title">Datos personales</h3>
    <div class="container">
      <h4>Nombre</h4>
      <div *ngIf = "!isAdmin">
        <div class="contenido-infomacion-personal">
          <div class="box-1">
            <p *ngIf="!isEditingFirstName" class="paragraph">{{ usuarioActual?.firstName }}</p>
            <form action="#" [formGroup]="formGroupFirstName">
              <input class="edit-input" *ngIf="isEditingFirstName" formControlName="firstname"/>
            </form>
    
            <button class="edit" *ngIf="!isEditingFirstName" (click)="toggleEditFirstame()">
              <img class="img-edit" src="/assets/Edit.png" alt="">
            </button>
    
            <div class="options-container">
               <button class="confirm-button" *ngIf="isEditingFirstName" (click)="confirmChangeFirstName()">✔</button>
               <button class="cancel-button" *ngIf="isEditingFirstName" (click)="cancelEdit()">✖</button>
            </div>
          </div>
  
          <div *ngIf="!showErrors && firstname_fc?.invalid && (firstname_fc?.dirty || firstname_fc?.touched)" class="errors">
            <div *ngIf="firstname_fc?.hasError('required')" class="text-danger">El nombre es requerido</div>
            <div *ngIf="firstname_fc?.hasError('soloLetras')" class="text-danger">Solo letras</div>
          </div>
  
          <div id="resultado-operacion" class="mt-3">{{resultFirstName}}</div>
        </div>
      </div>

      <div *ngIf = "isAdmin">
        <div class="contenido-infomacion-personal">
          <div class="box-1">
            <p *ngIf="!isEditingFirstName" class="paragraph">{{ adminActual?.firstName }}</p>
            <form action="#" [formGroup]="formGroupFirstName">
              <input class="edit-input" *ngIf="isEditingFirstName" formControlName="firstname"/>
            </form>
    
            <button class="edit" *ngIf="!isEditingFirstName" (click)="toggleEditFirstame()">
              <img class="img-edit" src="/assets/Edit.png" alt="">
            </button>
    
            <div class="options-container">
               <button class="confirm-button" *ngIf="isEditingFirstName" (click)="confirmChangeFirstName()">✔</button>
               <button class="cancel-button" *ngIf="isEditingFirstName" (click)="cancelEdit()">✖</button>
            </div>
          </div>
  
          <div *ngIf="!showErrors && firstname_fc?.invalid && (firstname_fc?.dirty || firstname_fc?.touched)" class="errors">
            <div *ngIf="firstname_fc?.hasError('required')" class="text-danger">El nombre es requerido</div>
            <div *ngIf="firstname_fc?.hasError('soloLetras')" class="text-danger">Solo letras</div>
          </div>
  
          <div id="resultado-operacion" class="mt-3">{{resultFirstName}}</div>
        </div>
      </div>

      <h4>Apellido</h4>
      <div *ngIf = "!isAdmin">
        <div class="contenido-infomacion-personal">
          <div class="box-1">
            <p *ngIf="!isEditingLastName" class="paragraph">{{usuarioActual?.lastName}}</p>
            <form action="#" [formGroup]="formGroupLastName">
              <input class="edit-input" *ngIf="isEditingLastName" formControlName="lastname"/>
            </form>
    
            <button class="edit" *ngIf="!isEditingLastName" (click)="toggleEditLastName()">
              <img class="img-edit" src="/assets/Edit.png" alt="">
            </button>
  
            <div class="options-container">
               <button class="confirm-button" *ngIf="isEditingLastName" (click)="confirmChangeLastName()">✔</button>
               <button class="cancel-button" *ngIf="isEditingLastName" (click)="cancelEdit()">✖</button>
            </div>
          </div>
  
          <div *ngIf="!showErrors && lastname_fc?.invalid && (lastname_fc?.dirty || lastname_fc?.touched)" class="errors">
            <div *ngIf="lastname_fc?.hasError('required')" class="text-danger">El apellido es requerido</div>
            <div *ngIf="firstname_fc?.hasError('soloLetras')" class="text-danger">Solo letras</div>
          </div>
  
          <div id="resultado-operacion" class="mt-3">{{resultLastName}}</div>
        </div>
      </div>

      <div *ngIf = "isAdmin">
        <div class="contenido-infomacion-personal">
          <div class="box-1">
            <p *ngIf="!isEditingLastName" class="paragraph">{{adminActual?.lastName}}</p>
            <form action="#" [formGroup]="formGroupLastName">
              <input class="edit-input" *ngIf="isEditingLastName" formControlName="lastname"/>
            </form>
    
            <button class="edit" *ngIf="!isEditingLastName" (click)="toggleEditLastName()">
              <img class="img-edit" src="/assets/Edit.png" alt="">
            </button>
  
            <div class="options-container">
               <button class="confirm-button" *ngIf="isEditingLastName" (click)="confirmChangeLastName()">✔</button>
               <button class="cancel-button" *ngIf="isEditingLastName" (click)="cancelEdit()">✖</button>
            </div>
          </div>
  
          <div *ngIf="!showErrors && lastname_fc?.invalid && (lastname_fc?.dirty || lastname_fc?.touched)" class="errors">
            <div *ngIf="lastname_fc?.hasError('required')" class="text-danger">El apellido es requerido</div>
            <div *ngIf="firstname_fc?.hasError('soloLetras')" class="text-danger">Solo letras</div>
          </div>
  
          <div id="resultado-operacion" class="mt-3">{{resultLastName}}</div>
        </div>
      </div>
      
      <div *ngIf = "!isAdmin">
        <h4>DNI</h4>
        <div class="contenido-dni">
          <div class="box-1">
            <p *ngIf="!isEditingDni" class="paragraph">{{ usuarioActual?.dni }}</p>
            <form action="#" [formGroup]="formGroupDNI">
              <input class="edit-input" *ngIf="isEditingDni" formControlName="dni"/>
            </form>
    
            <button class="edit" *ngIf="!isEditingDni" (click)="toggleEditDni()">
              <img class="img-edit" src="/assets/Edit.png" alt="">
            </button>
    
            <div class="options-container">
              <button class="confirm-button" *ngIf="isEditingDni" (click)="confirmChangeDNI()">✔</button>
              <button class="cancel-button" *ngIf="isEditingDni" (click)="cancelEdit()">✖</button>
            </div>
          </div>

          <div *ngIf="!showErrors && dni_fc?.invalid && (dni_fc?.dirty || dni_fc?.touched)" class="errors">
            <div *ngIf="dni_fc?.hasError('required')" class="text-danger">El DNI es requerido</div>
            <div *ngIf="dni_fc?.hasError('soloNumeros')" class="text-danger">DNI contiene solo numeros</div>
          </div>

          <div id="resultado-operacion" class="mt-3">{{resultDNI}}</div>
        </div>
      </div>
    </div> 
  </section>

  <section class="box-datos-de-cuenta">
    <h3 class="sub-title">Datos de Cuenta</h3>
    <div class="container">
      <h4>E-mail</h4>
      <div *ngIf = "!isAdmin"> 
        <div class="contenido-datos-de-cuenta">
          <div class="box-1">
            <div class="box-1">
              <p *ngIf="!isEditingEmail" class="paragraph">{{usuarioActual?.email}}</p>
              <form action="#" [formGroup]="formGroupEmail">
                <input type="email" class="edit-input" *ngIf="isEditingEmail" formControlName="email"/>
              </form>
      
              <button class="edit" *ngIf="!isEditingEmail" (click)="toggleEditEmail()">
                <img class="img-edit" src="/assets/Edit.png" alt="">
              </button>
            </div>
    
            <div class="options-container">
              <button class="confirm-button" *ngIf="isEditingEmail" type="submit" (click)="confirmChangeEmail()">✔</button>
              <button class="cancel-button" *ngIf="isEditingEmail" (click)="cancelEdit()">✖</button>
            </div>
          </div>
  
          <div *ngIf="!showErrors && email_fc?.invalid && (email_fc?.dirty || email_fc?.touched)" class="errors">
            <div *ngIf="email_fc?.hasError('required')" class="text-danger">El email es requerido</div>
            <div *ngIf="email_fc?.hasError('email')" class="text-danger">Formato de Email Incorrecto</div>
          </div>
  
          <div id="resultado-operacion" class="mt-3">{{resultEmail}}</div>
        </div>
      </div>

      <div *ngIf = "isAdmin">
        <div class="contenido-datos-de-cuenta">
          <div class="box-1">
            <div class="box-email-edit">
              <p *ngIf="!isEditingEmail" class="paragraph">{{adminActual?.email}}</p>
              <form action="#" [formGroup]="formGroupEmail">
                <input type="email" class="edit-input" *ngIf="isEditingEmail" formControlName="email"/>
              </form>
      
              <button class="edit" *ngIf="!isEditingEmail" (click)="toggleEditEmail()">
                <img class="img-edit" src="/assets/Edit.png" alt="">
              </button>
            </div>
    
            <div class="options-container">
              <button class="confirm-button" *ngIf="isEditingEmail" type="submit" (click)="confirmChangeEmail()">✔</button>
              <button class="cancel-button" *ngIf="isEditingEmail" (click)="cancelEdit()">✖</button>
            </div>
          </div>
  
          <div *ngIf="!showErrors && email_fc?.invalid && (email_fc?.dirty || email_fc?.touched)" class="errors">
            <div *ngIf="email_fc?.hasError('required')" class="text-danger">El email es requerido</div>
            <div *ngIf="email_fc?.hasError('email')" class="text-danger">Formato de Email Incorrecto</div>
          </div>
  
          <div id="resultado-operacion" class="mt-3">{{resultEmail}}</div>
        </div>
      </div>

      <h4>Contraseña</h4>
      <div class="contenido-datos-de-cuenta">
        <div class="box-password">
          <div class="box-1">
            <p *ngIf="!isEditingPassword" class="paragraph"> * * * * * * * * </p>
            <form action="#" [formGroup]="formGroupPassword">
              <input type="password" class="edit-input" *ngIf="isEditingPassword" formControlName="password"/>
            </form>

            <button class="edit" *ngIf="!isEditingPassword" (click)="toggleFormToEditPassword()">
              <img class="img-edit" src="/assets/Edit.png" alt="">
            </button>

            <div class="options-container">
              <button class="confirm-button" *ngIf="isEditingPassword" type="submit" (click)="confirmChangePassword()">✔</button>
              <button class="cancel-button" *ngIf="isEditingPassword" (click)="cancelEdit()">✖</button>
            </div>

            <div *ngIf="showFormToEditPassword">
              <div class="form-password">
                <h5 class="field">Ingrese su contraseña actual para seguir</h5>
                <div class="box-field">
                    <div class="box-input-password">
                      <input id="input-password" 
                      [(ngModel)]="passwordToVerify" 
                      [type]="showPassword ? 'text' : 'password'" 
                      placeholder="Contraseña actual...">
                    </div>
                    <div class="box-eye">
                      <button 
                        type="button" 
                        class="btn btn-link" 
                        (click)="toggleShowPassword()">
                        <i [ngClass]="showPassword ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
                      </button>
                    </div>
                </div>
                <div class="box-options-password">
                  <button class="button" (click)="toggleFormToEditPassword()">Cancelar</button>
                  <button class="button" (click)="verifyActualPasswordToEditNewPassword()">Enviar</button>
                </div>
                <div class="box-error">
                  {{resultInputPassword}}
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="!showErrors && password_fc?.invalid && (password_fc?.dirty || password_fc?.touched)" class="box-password">
            <div class="text-danger" *ngIf="password_fc?.hasError('required')">La contraseña es requerida</div>
            <div class="text-danger" *ngIf="password_fc?.hasError('minDosNumeros')">La contraseña debe contener mínimo 2 números</div>
            <div class="text-danger" *ngIf="password_fc?.hasError('minlength')">La contraseña debe contener mínimo 6 caracteres</div>
          </div>
  
          <div id="resultado-operacion" class="mt-3">{{resultPassword}}</div>
        </div>
      </div>
    </div>
  </section>

<div *ngIf = "!isAdmin">
    <section class="box-domicilios">
      <h3 class="sub-title">Domicilios</h3>
      <div class="container">
        <h4>Direccion</h4>
        <div class="contenido-datos-domicilios">
          <div class="box-1">
            <p *ngIf="!isEditingAddress" class="paragraph"> {{usuarioActual?.address}}</p>
            <form action="#" [formGroup]="formGroupAddress">
              <input class="edit-input" *ngIf="isEditingAddress" formControlName="address" />
            </form>
    
            <button class="edit" *ngIf="!isEditingAddress" (click)="toggleEditAddress()">
              <img class="img-edit" src="/assets/Edit.png" alt="">
            </button>
    
            <div class="options-container">
              <button class="confirm-button" *ngIf="isEditingAddress" (click)="confirmChangeAddress()">✔</button>
              <button class="cancel-button" *ngIf="isEditingAddress" (click)="cancelEdit()">✖</button>
            </div>
          </div>

          <div *ngIf="!showErrors && address_fc?.invalid && (address_fc?.dirty || address_fc?.touched)" class="errors">
            <div *ngIf="address_fc?.hasError('required')" class="text-danger">La direccion es requerida</div>
          </div>

          <div id="resultado-operacion" class="mt-3">{{resultAddress}}</div>
        </div>
      </div>
    </section>
</div>

<div *ngIf = "!isAdmin">
  <section class="box-tarjetas">
    <h3 class="sub-title">Mis Tarjetas</h3>
    <div class="container">
      <div class="box-1">

        <div class="mis-tarjetas">
          
          <div class="tarjeta" *ngIf="cardExists">
            <div class="chip"></div>
            <div class="box-datos">
              <p class="dato-tarjeta nTarjeta" *ngIf="!permitirEditarTarjeta"> **** **** **** {{lastFourDigits}}</p>
              <form class="formEditCard dato-tarjeta nTarjeta" action="#" [formGroup]="cardFormGroup" *ngIf="permitirEditarTarjeta">
                <input id="numberCard" class="dato-tarjeta nTarjeta input-edit" type="text" formControlName="nTarjeta">
              </form>
            </div>
            <div class="box-datos">
              <p class="dato-tarjeta vencimiento"  *ngIf="!permitirEditarTarjeta">{{ usuarioActual?.tarjeta?.fechaVencimiento }}</p>
              <form class="formEditCard dato-tarjeta vencimiento" action="#" [formGroup]="cardFormGroup" *ngIf="permitirEditarTarjeta">
                <input class="dato-tarjeta vencimiento input-edit" type="text" formControlName="fechaVencimiento">
              </form>
            </div>
            <div class="last-data">
              <div class="box-fullname">
                <div class="box-datos">
                  <p class="dato-tarjeta fullname"  *ngIf="!permitirEditarTarjeta">{{usuarioActual?.tarjeta?.firstName}}</p>
                  <form class="formEditCard dato-tarjeta" action="#" [formGroup]="cardFormGroup" *ngIf="permitirEditarTarjeta">
                    <input id="firstname" class="dato-tarjeta fullname-input input-edit firstname-edit" type="text" formControlName="firstName">
                  </form>
                </div>
                <div class="box-datos">
                  <p class="dato-tarjeta fullname"  *ngIf="!permitirEditarTarjeta">{{usuarioActual?.tarjeta?.lastName}}</p>
                  <form class="formEditCard dato-tarjeta" action="#" [formGroup]="cardFormGroup" *ngIf="permitirEditarTarjeta">
                    <input id="lastname" class="dato-tarjeta fullname-input input-edit" type="text" formControlName="lastName">
                  </form>
                </div>
              </div>
              <div class="dato-tarjeta tipo-tarjeta"><img [ngClass]="imgTypeCardClass" src="{{typeCard}}" alt=""></div>
            </div>
          </div>

          <div class="non-existent-card" *ngIf="!cardExists">
            <p class="paragraph">Aun no tiene una tarjeta cargada...</p>
          </div>

        <div class="box-opciones-tarjeta">
              <button *ngIf="!cardExists" class="button-new-tarjeta" (click)="showFormAddCard()"> 
                Agregar Tarjeta
              </button>
              <div *ngIf="formNewCard && showFormularioAddCard" class="tarjeta-form-overlay">
                <button class="cancel-form" (click)="hideFormAddCard()">X</button>
                <app-tarjeta-form></app-tarjeta-form>
              </div>

              <div *ngIf="cardExists" class="card-exist">
                
                <button *ngIf="showOptionButtonsToCard" class="button-delete" (click)="openDeleteCard()">
                  <img class="delete" src="/assets/delete.png" alt="">
                </button>
                <button *ngIf="showOptionButtonsToCard" class="edit button-edit-tarjeta" (click)="toggleFormPassword()">
                  <img class="img-edit-tarjeta" src="/assets/Edit.png" alt="">
                </button>

                <div *ngIf="showFormDeleteCard" class="modal-overlay">
                  <div class="modal-content">
                    <h3>¿Eliminar Tarjeta actual?</h3>
                    <div class="modal-buttons">
                      <button class="cancel-button-logout" (click)="closeDeleteCard()">Cancelar</button>
                      <button class="confirm-button-logout" (click)="deleteCard()">Confirmar</button>
                    </div>
                  </div>
                </div>

                <div *ngIf="showFormularioPassword">
                  <div class="form-password">
                    <h5 class="field">Ingrese su contraseña para seguir</h5>
                    <div class="box-field">
                        <div class="box-input-password">
                          <input id="input-password" 
                          [(ngModel)]="passwordToEdit" 
                          [type]="showPassword ? 'text' : 'password'" 
                          placeholder="Contraseña...">
                        </div>
                        <div class="box-eye">
                          <button 
                            type="button" 
                            class="btn btn-link" 
                            (click)="toggleShowPassword()">
                            <i [ngClass]="showPassword ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
                          </button>
                        </div>
                    </div>
                    <div class="box-options-password">
                      <button class="button" (click)="toggleFormPassword()">Cancelar</button>
                      <button class="button" (click)="verifyPassword()">Enviar</button>
                    </div>
                    <div class="box-error">
                      {{resultInputPassword}}
                    </div>
                  </div>
                </div>

                <div class="box-options-edit-card" *ngIf="activeOptionsEditCard">
                  <button id="button-cancel-edit-card" class="button-option-edit-card" (click)="cancelEditCard()">✖</button>
                  <button class="button-option-edit-card" (click)="confirmEditCard()">✔</button>
                </div>
              
              </div>

          </div>
        </div>
      </div>
    </div>
    <div class="box-errors">
      <section class="box-error" *ngIf="firstnameCard?.invalid && (firstnameCard?.dirty || firstnameCard?.touched)">
          <div *ngIf="firstnameCard?.hasError('required')" class="error-message">El nombre es requerido.</div>
          <div *ngIf="firstnameCard?.hasError('soloLetras')" class="error-message">El nombre debe contener solo letras.</div>
      </section>
  
      <section class="box-error" *ngIf="lastnameCard?.invalid && (lastnameCard?.dirty || lastnameCard?.touched)">
          <div *ngIf="lastnameCard?.hasError('required')" class="error-message"> El apellido es requerido.</div>
          <div *ngIf="lastnameCard?.hasError('soloLetras')" class="error-message">El apellido debe contener solo letras.</div>
      </section>
  
      <section class="box-error" *ngIf="numberCard && (numberCard.invalid && (numberCard.dirty || numberCard.touched))">
          <div *ngIf="numberCard.hasError('required')" class="error-message">El Nº de tarjeta es requerido.</div>
          <div *ngIf="numberCard.hasError('soloNumeros')" class="error-message">La tarjeta debe tener solo numeros. </div>
          <div *ngIf="numberCard.hasError('validarTarjetaLongitud')" class="error-message">El Nº de tarjeta son 16 digitos.</div>
      </section>
      
      <section class="box-error" *ngIf="fechaVencimientoCard && (fechaVencimientoCard.invalid && (fechaVencimientoCard.dirty || fechaVencimientoCard.touched))">
          <div *ngIf="fechaVencimientoCard.hasError('required')">La fecha de vencimiento es requerida.</div>
          <div *ngIf="fechaVencimientoCard.hasError('validarFormatoFechaVencimiento')">Formato fecha de vencimiento debe ser MM/YY.</div>
          <div *ngIf="fechaVencimientoCard.hasError('validarFechaNoExpirada')">Tarjeta vencida.</div>
      </section>
    </div>
    <div class="box-errors box-error">{{resultEditCard}}</div>
  </section>
</div>

  <section class="box-logout">
    <div class="contenido-logout">
      <button class="button-logout logout" (click)="openLogoutModal()">Cerrar sesión</button>
      <button class="button-logout" (click)="openDeleteAccountModal()" >Eliminar cuenta</button>
    </div>

    <div *ngIf="isDeleteAccountModalVisible" class="modal-overlay">
      <div class="modal-content">
        <h3>Desea eliminar su cuenta?</h3>
        <div class="modal-buttons">
          <button class="cancel-button-logout" (click)="closeDeleteAccountModal()">Cancelar</button>
          <button class="confirm-button-logout" (click)="deleteAccount()">Confirmar</button>
        </div>
      </div>
    </div>

    <div *ngIf="isLogoutModalVisible" class="modal-overlay">
      <div class="modal-content">
        <h3>¿Deseas cerrar sesión?</h3>
        <div class="modal-buttons">
          <button class="cancel-button-logout" (click)="closeLogoutModal()">Cancelar</button>
          <button class="confirm-button-logout" (click)="logout()">Confirmar</button>
        </div>
      </div>
    </div>
  </section>
</section>

